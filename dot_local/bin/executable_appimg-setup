#!/bin/bash

# Configuration
DEST_DIR="/opt/appimgs"
DESKTOP_DIR="$HOME/.local/share/applications"
TEMP_EXTRACT_DIR="/tmp/appimage_extract_$(date +%s)"

# Check for root privileges
if [ "$EUID" -ne 0 ]; then
  echo "Error: This script must be run with sudo."
  exit 1
fi

mkdir -p "$DEST_DIR"

# 1. Path to AppImage
read -p "Enter path to AppImage: " APP_PATH
[[ ! -f "$APP_PATH" ]] && {
  echo "Error: File not found."
  exit 1
}

# 2. Path to Icon (Optional)
read -p "Enter path to Icon (Leave empty to auto-extract): " ICON_PATH

# 3. Application Name
read -p "Enter Application Name: " APP_NAME
[[ -z "$APP_NAME" ]] && APP_NAME=$(basename "$APP_PATH" .AppImage)

APP_FILENAME=$(basename "$APP_PATH")
DESKTOP_FILENAME="${APP_NAME// /_}.desktop"

# Ensure AppImage is executable
chmod a+x "$APP_PATH"

# --- Icon Extraction Routine ---
if [[ -z "$ICON_PATH" ]]; then
  echo "Attempting to extract official icon..."
  mkdir -p "$TEMP_EXTRACT_DIR"
  cd "$TEMP_EXTRACT_DIR" || exit

  # Extract only icon files to save time/space
  # Most AppImages have a .DirIcon or a PNG named after the app in the root
  if "$APP_PATH" --appimage-extract "*.png" >/dev/null 2>&1 || "$APP_PATH" --appimage-extract ".DirIcon" >/dev/null 2>&1; then
    # Look for the best icon: .DirIcon first, then any png
    EXTRACTED_ICON=$(find squashfs-root -maxdepth 1 -name ".DirIcon" -o -name "*.png" | head -n 1)

    if [[ -n "$EXTRACTED_ICON" ]]; then
      ICON_FILENAME="${APP_NAME// /_}_icon.png"
      mv "$EXTRACTED_ICON" "$DEST_DIR/$ICON_FILENAME"
      ICON_PATH="$DEST_DIR/$ICON_FILENAME"
      echo "Successfully extracted: $ICON_FILENAME"
    fi
  fi

  # Cleanup temp files
  rm -rf "$TEMP_EXTRACT_DIR"
  cd - >/dev/null
fi

# Final Icon Assignment
if [[ -f "$ICON_PATH" ]]; then
  # If it was a manual path and not already in /opt, move it
  if [[ "$ICON_PATH" != "$DEST_DIR"* ]]; then
    ICON_FILENAME=$(basename "$ICON_PATH")
    mv "$ICON_PATH" "$DEST_DIR/"
    ICON_PATH="$DEST_DIR/$ICON_FILENAME"
  fi
  ICON_LINE="Icon=$ICON_PATH"
else
  echo "Warning: No icon found. Using fallback."
  ICON_LINE="Icon=system-run"
fi

# --- Finalize ---
mv "$APP_PATH" "$DEST_DIR/"

cat <<EOF >"$DESKTOP_DIR/$DESKTOP_FILENAME"
[Desktop Entry]
Name=$APP_NAME
Exec=$DEST_DIR/$APP_FILENAME --no-sandbox
$ICON_LINE
Terminal=false
Type=Application
Categories=Utility;
EOF

# Restore ownership to the user
REAL_USER=${SUDO_USER:-$USER}
chown "$REAL_USER":"$REAL_USER" "$DESKTOP_DIR/$DESKTOP_FILENAME"

echo "------------------------------------------------"
echo "Success! '$APP_NAME' has been indexed."
echo "Entry created at: $DESKTOP_DIR/$DESKTOP_FILENAME"
