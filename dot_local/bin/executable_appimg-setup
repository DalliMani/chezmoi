#!/bin/bash
set -euo pipefail

# ---- CONFIG ----
DEST_DIR="/opt/appimages"
REAL_USER="${SUDO_USER:-$USER}"
USER_HOME="$(getent passwd "$REAL_USER" | cut -d: -f6)"
DESKTOP_DIR="$USER_HOME/.local/share/applications"
TMP_DIR="$(mktemp -d)"

# ---- ROOT CHECK ----
if [[ $EUID -ne 0 ]]; then
  echo "Run with sudo"
  exit 1
fi

if [[ $# -ne 1 ]]; then
  echo "Usage: sudo $0 <AppImage>"
  exit 1
fi

APP_PATH="$(realpath "$1")"
[[ -f "$APP_PATH" ]] || {
  echo "File not found"
  exit 1
}

mkdir -p "$DEST_DIR" "$DESKTOP_DIR"

# ---- APP NAME ----
DEFAULT_NAME="$(basename "$APP_PATH" .AppImage)"
read -r -p "Application name [$DEFAULT_NAME]: " APP_NAME
APP_NAME="${APP_NAME:-$DEFAULT_NAME}"

APP_BASENAME="${APP_NAME// /_}"
APPIMAGE_DEST="$DEST_DIR/$APP_BASENAME.AppImage"
DESKTOP_FILE="$DESKTOP_DIR/$APP_BASENAME.desktop"
ICON_PATH=""

# ---- INSTALL APPIMAGE ----
cp "$APP_PATH" "$APPIMAGE_DEST"
chmod 755 "$APPIMAGE_DEST"

# ---- ICON EXTRACTION ----
echo "Extracting iconâ€¦"
cd "$TMP_DIR"
"$APPIMAGE_DEST" --appimage-extract >/dev/null 2>&1 || true

if [[ -d squashfs-root ]]; then
  ICON_CANDIDATE="$(find squashfs-root -type f \( -name '*.png' -o -name '.DirIcon' \) | sort | head -n 1)"
  if [[ -n "$ICON_CANDIDATE" ]]; then
    ICON_PATH="$DEST_DIR/$APP_BASENAME.png"
    cp "$ICON_CANDIDATE" "$ICON_PATH"
    chmod 644 "$ICON_PATH"
  fi
fi

rm -rf "$TMP_DIR"

# ---- DESKTOP ENTRY ----
cat >"$DESKTOP_FILE" <<EOF
[Desktop Entry]
Name=$APP_NAME
Exec="$APPIMAGE_DEST"
Icon=${ICON_PATH:-system-run}
Terminal=false
Type=Application
Categories=Utility;
EOF

# ---- OWNERSHIP ----
chown "$REAL_USER:$REAL_USER" "$DESKTOP_FILE"
chown "$REAL_USER:$REAL_USER" "$APPIMAGE_DEST"
[[ -n "$ICON_PATH" ]] && chown "$REAL_USER:$REAL_USER" "$ICON_PATH"

echo "Installed:"
echo "  AppImage: $APPIMAGE_DEST"
echo "  Desktop : $DESKTOP_FILE"
